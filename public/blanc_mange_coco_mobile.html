<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Blanc Mang√© Coco ‚Äî Mobile</title>

<style>
/* dynamic vh fix for mobile browser chrome/url bar */
:root { --vh: 1vh; --vert: #0DFF8A; --bg:#06120b; --bg2:#0b1a13; --cardW:150px; --cardH:210px; }
function{} /*noop to avoid some linters*/ 
html,body{height:calc(var(--vh)*100);}

body{
  margin:0;
  padding:env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
  background:var(--bg);
  color:var(--vert);
  font-family: "Madloud", Arial, sans-serif;
  -webkit-font-smoothing:antialiased;
  overflow:hidden;
  touch-action:manipulation;
  -webkit-tap-highlight-color: transparent;
}

/* load local Madloud (put madloud.ttf in /public) */
@font-face { font-family: "Madloud"; src: url("madloud.ttf") format("truetype"); font-weight: normal; font-style: normal; }

/* layout */
#app { display:flex; flex-direction:column; height:calc(var(--vh)*100); box-sizing:border-box; }

/* QUESTION BAR (fixed at top) */
#questionBar {
  background:var(--bg2);
  border-bottom:3px solid var(--vert);
  padding:12px 14px;
  text-align:center;
  font-size:1.25rem;
  box-sizing:border-box;
  z-index:30;
  flex:0 0 auto;
}

/* content area between question and bottom players bar */
#content {
  position:relative;
  flex:1 1 auto;
  overflow:hidden;
  display:flex;
  flex-direction:column;
}

/* CARDS POSED area (horizontal scroll) */
#posedZone {
  box-sizing:border-box;
  padding:12px;
  display:flex;
  align-items:flex-start;
  gap:12px;
  overflow-x:auto;
  overflow-y:hidden;
  white-space:nowrap;
  flex:1 0 auto;
}

/* PLAYER HAND area (bottom above playersBar) */
#handZone {
  box-sizing:border-box;
  padding:10px;
  border-top:3px solid rgba(13,255,138,0.12);
  background:rgba(0,0,0,0.25);
  display:flex;
  gap:12px;
  overflow-x:auto;
  flex:0 0 auto;
  height: calc(var(--cardH) * 0.9 + 20px);
  align-items:flex-start;
}

/* players bar at absolute bottom */
#playersBar {
  position: absolute;
  left:0; right:0; bottom:0;
  height:52px;
  background:rgba(0,0,0,0.85);
  border-top:2px solid var(--vert);
  display:flex;
  align-items:center;
  gap:8px;
  padding:6px 10px;
  overflow-x:auto;
  box-sizing:border-box;
  z-index:40;
  font-family:Arial, sans-serif;
}

/* ensure content bottom spacing so handZone not hidden by playersBar */
.spacer-bottom { height: 52px; flex:0 0 auto; }

/* CARD styles (common for posed & hand) */
/* card container uses background image and text sits on top (z-index) */
.card {
  width: var(--cardW);
  height: var(--cardH);
  flex:0 0 auto;
  background-image: url("carte.png");
  background-size: cover;
  background-position: center;
  border-radius:12px;
  border: 2px solid rgba(13,255,138,0.12);
  position:relative; /* IMPORTANT so text is above */
  box-shadow: 0 6px 18px rgba(0,0,0,0.5);
  display:flex;
  flex-direction:column;
  justify-content:flex-start; /* text at top */
  padding:10px;
  box-sizing:border-box;
  cursor:pointer;
  -webkit-user-select:none;
}

/* text box on top with padding (Option B) */
.card .card-text {
  background: rgba(255,255,255,0.92); /* light box for readability */
  color: #04120a; /* dark text for contrast */
  padding:6px 8px;
  border-radius:8px;
  font-family: Arial, sans-serif;
  font-size:0.85rem;
  line-height:1.05rem;
  max-height: calc(var(--cardH) * 0.45);
  overflow:hidden;
  box-shadow: 0 2px 6px rgba(0,0,0,0.25);
  z-index:12;
  pointer-events:none;
}

/* small responsive tweak: more visible border */
.card:active { transform: translateY(-2px) scale(0.995); }

/* chat & params floating tabs (compact) */
.tab {
  position:fixed;
  z-index:60;
  width:48px;
  height:48px;
  border-radius:12px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:20px;
  color:#04120a;
  background:var(--vert);
  box-shadow:0 8px 20px rgba(13,255,138,0.12);
  -webkit-tap-highlight-color: transparent;
}

#chatTab { right:14px; bottom:70px; }
#paramTab { right:14px; bottom:14px; }

/* panels */
.panel {
  position:fixed;
  z-index:70;
  right:12px;
  width:300px;
  max-width:86vw;
  background:var(--bg2);
  border:2px solid var(--vert);
  border-radius:12px;
  box-shadow:0 18px 40px rgba(0,0,0,0.6);
  display:none;
  flex-direction:column;
  overflow:hidden;
}

#chatPanel { bottom:128px; height:360px; }
#paramPanel { bottom:128px; height:auto; padding:12px; }

/* chat styling */
#chatMessages { flex:1; overflow:auto; padding:10px; font-family:Arial, sans-serif; color:white; }
.chatInputRow { display:flex; gap:8px; padding:10px; background:rgba(0,0,0,0.06); }
.chatInput { flex:1; padding:10px; border-radius:8px; border:none; font-size:0.95rem; }

/* param button style */
.paramBtn { width:100%; padding:10px; margin:6px 0; border-radius:8px; border:none; background:var(--vert); color:#04120a; font-size:1rem; }

/* players item */
.playerItem { background:var(--bg2); border:1px solid rgba(13,255,138,0.12); padding:6px 10px; border-radius:8px; color:var(--vert); white-space:nowrap; font-family:Arial, sans-serif; font-size:0.9rem; }

/* small helpers */
.hidden { display:none !important; }
</style>
</head>
<body>
<div id="app">
  <div id="questionBar">Chargement‚Ä¶</div>

  <div id="content">
    <div id="posedZone" aria-live="polite"></div>

    <!-- hand zone sits above playersBar: to avoid overlap we add spacer and playersBar is absolute -->
    <div id="handZone"></div>
    <div class="spacer-bottom"></div>
  </div>

  <!-- players bar fixed at bottom -->
  <div id="playersBar" aria-hidden="false"></div>
</div>

<!-- floating tabs -->
<button id="chatTab" class="tab">üí¨</button>
<button id="paramTab" class="tab">‚öôÔ∏è</button>

<!-- chat panel -->
<div id="chatPanel" class="panel" role="dialog" aria-label="Chat">
  <div id="chatMessages"></div>
  <div class="chatInputRow">
    <input id="chatInput" class="chatInput" placeholder="√âcrire un message‚Ä¶" />
    <button id="sendChatBtn" class="paramBtn">Envoyer</button>
  </div>
</div>

<!-- param panel -->
<div id="paramPanel" class="panel">
  <button id="btnChangeQuestion" class="paramBtn">Changer la carte</button>
  <button id="btnChangeHand" class="paramBtn">Changer la main</button>
  <button id="btnQuit" class="paramBtn">Quitter</button>
  <button id="btnCloseParam" class="paramBtn" style="background:#333;color:var(--vert);">Fermer</button>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
/* --- viewport vh fix (must run early) --- */
function updateVh(){
  let vh = window.innerHeight * 0.01;
  document.documentElement.style.setProperty('--vh', `${vh}px`);
}
updateVh();
window.addEventListener('resize', updateVh);
window.addEventListener('orientationchange', updateVh);

/* --- DOM refs --- */
const questionBar = document.getElementById('questionBar');
const posedZone = document.getElementById('posedZone');
const handZone = document.getElementById('handZone');
const playersBar = document.getElementById('playersBar');

const chatTab = document.getElementById('chatTab');
const paramTab = document.getElementById('paramTab');
const chatPanel = document.getElementById('chatPanel');
const paramPanel = document.getElementById('paramPanel');
const chatMessages = document.getElementById('chatMessages');
const chatInput = document.getElementById('chatInput');
const sendChatBtn = document.getElementById('sendChatBtn');

const btnChangeQuestion = document.getElementById('btnChangeQuestion');
const btnChangeHand = document.getElementById('btnChangeHand');
const btnQuit = document.getElementById('btnQuit');
const btnCloseParam = document.getElementById('btnCloseParam');

/* --- socket --- */
const socket = io();

/* keep track of my pseudo so we don't prompt repeatedly */
let myPseudo = null;
function askPseudo(){
  if(myPseudo) return;
  myPseudo = prompt("Choisis un pseudo :");
  if(!myPseudo) myPseudo = 'Player'+Math.floor(Math.random()*1000);
  socket.emit('rejoindreSalon', myPseudo);
}
setTimeout(askPseudo,200);

/* --- UI toggle handlers --- */
chatTab.addEventListener('click',()=> {
  chatPanel.style.display = chatPanel.style.display === 'flex' ? 'none' : 'flex';
  paramPanel.style.display = 'none';
});
paramTab.addEventListener('click',()=> {
  paramPanel.style.display = paramPanel.style.display === 'flex' ? 'none' : 'flex';
  chatPanel.style.display = 'none';
});

/* send chat */
function sendChat(){
  const v = chatInput.value.trim();
  if(!v) return;
  socket.emit('chatMessage', v);
  chatInput.value='';
}
sendChatBtn.addEventListener('click', sendChat);
chatInput.addEventListener('keydown', e=> { if(e.key==='Enter') sendChat(); });

/* --- helpers to create card nodes --- */
function makeCard(text, idx, clickHandler){
  const el = document.createElement('div');
  el.className = 'card';
  el.dataset.index = idx;
  // text container (Option B: padding + top)
  const txt = document.createElement('div');
  txt.className = 'card-text';
  txt.textContent = text;
  el.appendChild(txt);
  if(clickHandler){
    el.addEventListener('click', ()=> clickHandler(Number(el.dataset.index)));
  }
  return el;
}

/* --- rendering handlers using deterministic indexes --- */
socket.on('question', q => {
  questionBar.textContent = q || '...';
});

/* render my hand: each card clickable to poser by index */
socket.on('main', hand => {
  handZone.innerHTML = '';
  hand.forEach((txt,i)=>{
    const card = makeCard(txt, i, (index)=> socket.emit('poserCarteIndex', index));
    card.classList.add('hand-card');
    handZone.appendChild(card);
  });
  // ensure hand not hidden by players bar: scroll to start
  handZone.scrollLeft = 0;
});

/* render cards posed (non-vote) */
socket.on('cartesPosees', list => {
  posedZone.innerHTML = '';
  list.forEach((cObj,i)=>{
    const txt = (typeof cObj === 'string') ? cObj : (cObj.carte || '');
    const card = makeCard(txt, i);
    posedZone.appendChild(card);
  });
  posedZone.scrollLeft = 0;
});

/* phase vote: replace posed zone with clickable vote cards */
socket.on('phaseVote', cards => {
  posedZone.innerHTML = '';
  cards.forEach((txt,i)=>{
    const card = makeCard(txt, i, (index) => {
      socket.emit('voter', index);
      // local feedback
      card.style.boxShadow = '0 0 18px rgba(13,255,138,0.35)';
    });
    posedZone.appendChild(card);
  });
  posedZone.scrollLeft = 0;
});

/* nouveau tour: server sends nouveauTour with salon and gagnants optionally */
socket.on('nouveauTour', data => {
  // Clear posed cards, server will send new main events
  posedZone.innerHTML = '';
  // If server provided updated salon mains, the 'main' event will arrive; otherwise request
  if(data && data.salon && data.salon.joueurs && socket.id){
    const me = data.salon.joueurs[socket.id];
    if(me && me.main) {
      // some servers may send arrays; handle carefully
      socket.emit('rejoindreSalon', myPseudo); // trigger to refresh main (server logic)
    }
  }
});

/* chat messages */
socket.on('chatMessage', msg => {
  const d = document.createElement('div');
  d.textContent = msg;
  chatMessages.appendChild(d);
  chatMessages.scrollTop = chatMessages.scrollHeight;
});

/* players list updates (etatSalon) */
socket.on('etatSalon', salon => {
  playersBar.innerHTML = '';
  Object.values(salon.joueurs || {}).forEach(j => {
    const item = document.createElement('div');
    item.className = 'playerItem';
    item.textContent = `${j.pseudo} ‚Ä¢ ${j.points}pt`;
    playersBar.appendChild(item);
  });
});

/* --- param buttons actions --- */
btnChangeQuestion.addEventListener('click', ()=> { socket.emit('changerQuestion'); paramPanel.style.display='none'; });
btnChangeHand.addEventListener('click', ()=> { socket.emit('changerMain'); paramPanel.style.display='none'; });
btnQuit.addEventListener('click', ()=> { socket.emit('deconnexion'); window.location.href='index.html'; });
btnCloseParam.addEventListener('click', ()=> paramPanel.style.display='none');

/* safeguard: if image missing, show simple fallback card text (optional) */
function checkCardImage(){
  const img = new Image();
  img.onload = ()=>{/* ok */};
  img.onerror = ()=>{
    // replace CSS backgrounds with simple pale card color
    const style = document.createElement('style');
    style.innerHTML = `.card{ background-image:none; background-color:#e6f9ee; border:2px solid rgba(13,255,138,0.18); } .card .card-text{ background:transparent; color:#04120a; }`;
    document.head.appendChild(style);
  };
  img.src = 'carte.png';
}
checkCardImage();

/* ensure we re-request pseudo if reload */
window.addEventListener('beforeunload', ()=> {
  try{ socket.emit('deconnexion'); }catch(e){}
});

/* small: make sure taps are crisp */
document.addEventListener('touchstart', ()=>{}, {passive:true});
</script>
</body>
</html>
