<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Kukipix</title>
<style>
:root { 
  --vh: 1vh; 
  --vert: #0DFF8A; 
  --bg: #06120b; 
  --bg2: #0b1a13; 
}

html, body {
  height: calc(var(--vh) * 100);
}

body {
  margin: 0;
  padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
  background: var(--bg);
  color: var(--vert);
  font-family: "TFMadloud", Arial, sans-serif;
  -webkit-font-smoothing: antialiased;
  overflow-x: hidden;
}

@font-face { 
  font-family: "TFMadloud"; 
  src: url("fonts/TF-Madloud.ttf") format("truetype"); 
  font-weight: normal; 
  font-style: normal; 
}

#app {
  min-height: 100vh;
  display: flex;
  flex-direction: column;
}

.header {
  background: var(--bg2);
  border-bottom: 3px solid var(--vert);
  padding: 20px;
  text-align: center;
}

.header h1 {
  font-size: 2.5rem;
  margin: 0;
  color: var(--vert);
}

.header .subtitle {
  color: rgba(13, 255, 138, 0.7);
  font-size: 0.9rem;
  margin-top: 5px;
}

.game-container {
  flex: 1;
  padding: 20px;
  max-width: 1200px;
  margin: 0 auto;
  width: 100%;
  box-sizing: border-box;
}

.waiting-screen {
  text-align: center;
  padding: 60px 20px;
}

.waiting-screen h2 {
  color: var(--vert);
  margin-bottom: 30px;
  font-size: 2rem;
}

.info-bar {
  background: var(--bg2);
  border: 2px solid rgba(13, 255, 138, 0.2);
  border-radius: 12px;
  padding: 15px;
  margin-bottom: 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 15px;
}

.info-item {
  display: flex;
  flex-direction: column;
  align-items: center;
}

.info-label {
  font-size: 0.8rem;
  color: rgba(13, 255, 138, 0.6);
  margin-bottom: 5px;
}

.info-value {
  font-size: 1.3rem;
  color: var(--vert);
  font-weight: bold;
}

.image-zone {
  background: var(--bg2);
  border: 3px solid rgba(13, 255, 138, 0.3);
  border-radius: 15px;
  padding: 20px;
  margin-bottom: 20px;
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 500px;
  position: relative;
}

#gameImage {
  max-width: 100%;
  max-height: 500px;
  min-width: 300px;
  min-height: 300px;
  object-fit: contain;
  border-radius: 10px;
  box-shadow: 0 0 30px rgba(13, 255, 138, 0.2);
  image-rendering: pixelated;
}

.image-quality {
  position: absolute;
  top: 10px;
  right: 10px;
  background: rgba(13, 255, 138, 0.9);
  color: var(--bg);
  padding: 8px 15px;
  border-radius: 8px;
  font-size: 0.85rem;
  font-weight: bold;
}

.reveal-countdown {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: rgba(13, 255, 138, 0.95);
  color: var(--bg);
  padding: 20px 40px;
  border-radius: 15px;
  font-size: 1.5rem;
  font-weight: bold;
  box-shadow: 0 0 30px rgba(13, 255, 138, 0.8);
  animation: pulse 1s infinite;
  z-index: 10;
}

@keyframes pulse {
  0%, 100% { transform: translate(-50%, -50%) scale(1); }
  50% { transform: translate(-50%, -50%) scale(1.05); }
}

.mots-cles-section {
  background: var(--bg2);
  border: 2px solid rgba(13, 255, 138, 0.2);
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 20px;
}

.mots-cles-section h3 {
  color: var(--vert);
  margin: 0 0 15px 0;
  text-align: center;
}

#motsClesList {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  justify-content: center;
  min-height: 50px;
}

.mot-cle-item {
  background: var(--vert);
  color: var(--bg);
  padding: 8px 16px;
  border-radius: 20px;
  font-size: 0.9rem;
  font-weight: bold;
  display: flex;
  align-items: center;
  gap: 8px;
  box-shadow: 0 4px 12px rgba(13, 255, 138, 0.3);
  animation: slideIn 0.3s ease;
}

@keyframes slideIn {
  from { transform: translateY(-10px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

.mot-cle-points {
  background: var(--bg);
  color: var(--vert);
  padding: 2px 8px;
  border-radius: 10px;
  font-size: 0.8rem;
}

.answer-zone {
  background: var(--bg2);
  border: 2px solid rgba(13, 255, 138, 0.2);
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 20px;
}

.answer-input {
  display: flex;
  gap: 10px;
}

.answer-input input {
  flex: 1;
  background: var(--bg);
  border: 2px solid var(--vert);
  border-radius: 10px;
  padding: 15px;
  font-size: 1.1rem;
  color: var(--vert);
  font-family: Arial, sans-serif;
}

.answer-input input::placeholder {
  color: rgba(13, 255, 138, 0.4);
}

.answer-input input:focus {
  outline: none;
  border-color: var(--vert);
  box-shadow: 0 0 15px rgba(13, 255, 138, 0.3);
}

.btn {
  padding: 15px 30px;
  border: none;
  border-radius: 10px;
  font-size: 1.1rem;
  font-weight: bold;
  cursor: pointer;
  font-family: "TFMadloud", Arial, sans-serif;
  transition: transform 0.2s, box-shadow 0.2s;
}

.btn:hover {
  transform: translateY(-2px);
}

.btn:active {
  transform: translateY(0);
}

.btn-primary {
  background: var(--vert);
  color: var(--bg);
  box-shadow: 0 4px 15px rgba(13, 255, 138, 0.4);
}

.btn-primary:hover {
  box-shadow: 0 6px 20px rgba(13, 255, 138, 0.6);
}

.players-section {
  background: var(--bg2);
  border: 2px solid rgba(13, 255, 138, 0.2);
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 20px;
}

.players-section h3 {
  color: var(--vert);
  margin: 0 0 15px 0;
}

.player-item {
  background: var(--bg);
  border: 1px solid rgba(13, 255, 138, 0.2);
  padding: 12px 15px;
  margin-bottom: 10px;
  border-radius: 8px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.player-name {
  color: var(--vert);
  font-weight: bold;
}

.player-points {
  color: var(--vert);
  font-weight: bold;
  font-size: 1.1rem;
}

.chat-section {
  background: var(--bg2);
  border: 2px solid rgba(13, 255, 138, 0.2);
  border-radius: 12px;
  padding: 15px;
  max-height: 200px;
  overflow-y: auto;
}

.chat-message {
  color: rgba(13, 255, 138, 0.8);
  padding: 8px 0;
  font-size: 0.9rem;
  font-family: Arial, sans-serif;
  border-bottom: 1px solid rgba(13, 255, 138, 0.1);
}

.chat-message:last-child {
  border-bottom: none;
}

.resultat-screen {
  text-align: center;
  padding: 40px 20px;
}

.resultat-screen h2 {
  color: var(--vert);
  font-size: 2.5rem;
  margin-bottom: 20px;
}

.reponse-finale {
  background: var(--bg2);
  border: 3px solid var(--vert);
  border-radius: 12px;
  padding: 20px;
  margin: 30px 0;
  font-size: 1.5rem;
}

.podium {
  display: flex;
  flex-direction: column;
  gap: 15px;
  margin: 30px 0;
}

.podium-item {
  background: var(--bg2);
  border: 2px solid rgba(13, 255, 138, 0.3);
  padding: 20px;
  border-radius: 12px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.podium-item.first {
  border-color: #FFD700;
  box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
}

.podium-item.second {
  border-color: #C0C0C0;
  box-shadow: 0 0 20px rgba(192, 192, 192, 0.3);
}

.podium-item.third {
  border-color: #CD7F32;
  box-shadow: 0 0 20px rgba(205, 127, 50, 0.3);
}

.countdown {
  color: var(--vert);
  font-size: 1.2rem;
  margin-top: 30px;
}

.hidden {
  display: none !important;
}

@media (max-width: 768px) {
  .header h1 {
    font-size: 1.8rem;
  }
  
  .info-bar {
    justify-content: center;
  }
  
  .image-zone {
    min-height: 300px;
  }
  
  #gameImage {
    min-width: 200px;
    min-height: 200px;
  }
}
</style>
</head>
<body>
<div id="app">
  <div class="header">
    <h1>üé® KUKIPIX</h1>
    <div class="subtitle">Devine les mots-cl√©s de l'image !</div>
  </div>

  <div class="game-container">
    <!-- √âcran d'attente -->
    <div id="waitingScreen" class="waiting-screen">
      <h2>En attente de joueurs...</h2>
      <p id="progressInfo" style="color: var(--vert); margin: 20px 0;"></p>
      <button class="btn btn-primary" onclick="demarrerPartie()">üéÆ D√âMARRER</button>
    </div>

    <!-- √âcran de jeu -->
    <div id="gameScreen" class="hidden">
      <div class="info-bar">
        <div class="info-item">
          <div class="info-label">TEMPS</div>
          <div class="info-value" id="timer">00:00</div>
        </div>
        <div class="info-item">
          <div class="info-label">PROGRESSION</div>
          <div class="info-value" id="partieProgress">1/10</div>
        </div>
        <div class="info-item">
          <div class="info-label">MOTS-CL√âS</div>
          <div class="info-value" id="motsClesCount">0/0</div>
        </div>
      </div>

      <div class="image-zone">
        <div class="image-quality" id="imageQuality">25px</div>
        <div id="revealCountdown" class="reveal-countdown hidden">
          R√©sultats dans <span id="revealSeconds">10</span>s
        </div>
        <img id="gameImage" src="" alt="Image myst√®re" />
      </div>

      <div class="mots-cles-section">
        <h3>üéØ MOTS-CL√âS TROUV√âS</h3>
        <div id="motsClesList"></div>
      </div>

      <div class="answer-zone">
        <div class="answer-input">
          <input 
            type="text" 
            id="answerInput" 
            placeholder="Tape un mot-cl√©..."
            onkeypress="if(event.key==='Enter') proposerReponse()"
          />
          <button class="btn btn-primary" onclick="proposerReponse()">‚úì VALIDER</button>
        </div>
      </div>

      <div class="players-section">
        <h3>üë• JOUEURS</h3>
        <div id="playersList"></div>
      </div>

      <div class="chat-section" id="chatArea"></div>
    </div>

    <!-- √âcran de r√©sultat -->
    <div id="resultScreen" class="hidden resultat-screen">
      <h2>üèÜ MANCHE TERMIN√âE</h2>
      <div class="reponse-finale">
        R√©ponse : <strong id="correctAnswer"></strong>
      </div>
      
      <div class="podium" id="podium"></div>
      
      <div class="countdown">
        ‚è±Ô∏è Prochaine image dans <span id="countdownValue">5</span> secondes...
      </div>
    </div>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
console.log('üöÄ Kukipix charg√©');

/* Viewport fix */
function updateVh(){
  let vh = window.innerHeight * 0.01;
  document.documentElement.style.setProperty('--vh', `${vh}px`);
}
updateVh();
window.addEventListener('resize', updateVh);

const socket = io();

let myPseudo = null;
let timerInterval = null;
let startTime = null;
let countdownInterval = null;
let revealCountdownInterval = null;

function askPseudo() {
  if (myPseudo) return;
  myPseudo = prompt("Choisis un pseudo :");
  if (!myPseudo) myPseudo = 'Joueur' + Math.floor(Math.random() * 1000);
  socket.emit('joinGame', 'kukipix');
  socket.emit('rejoindreSalonKukipix', myPseudo);
}
setTimeout(askPseudo, 200);

function demarrerPartie() {
  socket.emit('demarrerPartie');
}

function proposerReponse() {
  const input = document.getElementById('answerInput');
  const reponse = input.value.trim();
  if (reponse) {
    socket.emit('proposerReponse', reponse);
    input.value = '';
  }
}

function formatTime(ms) {
  const seconds = Math.floor(ms / 1000);
  const minutes = Math.floor(seconds / 60);
  const secs = seconds % 60;
  return `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
}

function startTimer() {
  if (timerInterval) clearInterval(timerInterval);
  startTime = Date.now();
  
  timerInterval = setInterval(() => {
    const elapsed = Date.now() - startTime;
    document.getElementById('timer').textContent = formatTime(elapsed);
  }, 100);
}

function stopTimer() {
  if (timerInterval) {
    clearInterval(timerInterval);
    timerInterval = null;
  }
}

function startCountdown(seconds) {
  if (countdownInterval) clearInterval(countdownInterval);
  
  let remaining = seconds;
  const countdownEl = document.getElementById('countdownValue');
  if (countdownEl) {
    countdownEl.textContent = remaining;
  }
  
  countdownInterval = setInterval(() => {
    remaining--;
    if (remaining <= 0) {
      clearInterval(countdownInterval);
    } else if (countdownEl) {
      countdownEl.textContent = remaining;
    }
  }, 1000);
}

function startRevealCountdown(seconds) {
  if (revealCountdownInterval) clearInterval(revealCountdownInterval);
  
  const revealEl = document.getElementById('revealCountdown');
  const secondsEl = document.getElementById('revealSeconds');
  
  if (revealEl) revealEl.classList.remove('hidden');
  
  let remaining = seconds;
  if (secondsEl) secondsEl.textContent = remaining;
  
  revealCountdownInterval = setInterval(() => {
    remaining--;
    if (remaining <= 0) {
      clearInterval(revealCountdownInterval);
      if (revealEl) revealEl.classList.add('hidden');
    } else if (secondsEl) {
      secondsEl.textContent = remaining;
    }
  }, 1000);
}

// Socket events
socket.on('nouvellePartie', data => {
  console.log('üéÆ Nouvelle partie', data);
  document.getElementById('waitingScreen').classList.add('hidden');
  document.getElementById('gameScreen').classList.remove('hidden');
  document.getElementById('resultScreen').classList.add('hidden');
  document.getElementById('gameImage').src = '';
  document.getElementById('answerInput').value = '';
  document.getElementById('imageQuality').textContent = '25px';
  document.getElementById('revealCountdown').classList.add('hidden');
  document.getElementById('motsClesCount').textContent = `0/${data.totalMotsCles || 0}`;
  document.getElementById('motsClesList').innerHTML = '';
  document.getElementById('partieProgress').textContent = `${data.partieNum || 1}/${data.totalImages || '?'}`;
  
  // Arr√™ter tous les timers
  if (revealCountdownInterval) clearInterval(revealCountdownInterval);
  if (countdownInterval) clearInterval(countdownInterval);
  
  startTimer();
});

socket.on('imageUpdate', data => {
  console.log('üñºÔ∏è Image re√ßue:', data.size);
  document.getElementById('gameImage').src = data.image;
  document.getElementById('imageQuality').textContent = data.size;
  
  // Si c'est l'original, d√©marrer le compte √† rebours de 10s
  if (data.size === 'original') {
    startRevealCountdown(10);
  }
});

socket.on('motTrouve', data => {
  console.log('üéØ Mot trouv√©:', data);
  
  document.getElementById('motsClesCount').textContent = `${data.totalTrouves}/${data.totalMotsCles}`;
  
  const motsList = document.getElementById('motsClesList');
  const motItem = document.createElement('div');
  motItem.className = 'mot-cle-item';
  motItem.innerHTML = `
    <span>${data.mot}</span>
    <span class="mot-cle-points">+${data.points}</span>
    <span style="font-size: 0.8rem; opacity: 0.8;">${data.joueur}</span>
  `;
  motsList.appendChild(motItem);
});

socket.on('etatSalon', salon => {
  const playersList = document.getElementById('playersList');
  if (!playersList) return;
  
  playersList.innerHTML = '';
  
  Object.values(salon.joueurs || {}).forEach(j => {
    const item = document.createElement('div');
    item.className = 'player-item';
    item.innerHTML = `
      <span class="player-name">${j.pseudo}</span>
      <span class="player-points">${j.points} pts</span>
    `;
    playersList.appendChild(item);
  });
});

socket.on('chatMessage', msg => {
  const chatArea = document.getElementById('chatArea');
  const div = document.createElement('div');
  div.className = 'chat-message';
  div.textContent = msg;
  chatArea.appendChild(div);
  chatArea.scrollTop = chatArea.scrollHeight;
});

socket.on('finPartie', data => {
  console.log('üèÅ Fin de partie');
  stopTimer();
  
  document.getElementById('gameScreen').classList.add('hidden');
  document.getElementById('resultScreen').classList.remove('hidden');
  
  // Afficher la r√©ponse compl√®te avec les mots non trouv√©s
  let reponseHTML = data.reponse;
  if (data.motsClesNonTrouves && data.motsClesNonTrouves.length > 0) {
    reponseHTML += '<br><span style="color: rgba(13, 255, 138, 0.6); font-size: 0.8em;">Mots manqu√©s : ' + 
                   data.motsClesNonTrouves.join(', ') + '</span>';
  }
  document.getElementById('correctAnswer').innerHTML = reponseHTML;
  
  const podium = document.getElementById('podium');
  podium.innerHTML = '';
  
  data.classement.forEach((joueur, index) => {
    const item = document.createElement('div');
    item.className = 'podium-item';
    if (index === 0) item.classList.add('first');
    else if (index === 1) item.classList.add('second');
    else if (index === 2) item.classList.add('third');
    
    const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `${index + 1}.`;
    
    item.innerHTML = `
      <span style="font-size: 1.3rem;">${medal} ${joueur.pseudo}</span>
      <span style="font-weight: bold; color: var(--vert); font-size: 1.3rem;">${joueur.points} pts</span>
    `;
    podium.appendChild(item);
  });
  
  startCountdown(5);
});

socket.on('toutesImagesJouees', () => {
  console.log('üèÅ Toutes les images jou√©es !');
  document.getElementById('gameScreen').classList.add('hidden');
  document.getElementById('resultScreen').classList.add('hidden');
  document.getElementById('waitingScreen').classList.remove('hidden');
  
  const progressInfo = document.getElementById('progressInfo');
  progressInfo.textContent = 'üéâ Toutes les images ont √©t√© jou√©es ! Bravo !';
  progressInfo.style.fontSize = '1.2rem';
});

console.log('‚úÖ Client Kukipix pr√™t');
</script>
</body>
</html>